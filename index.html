<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bail Me — MVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Bail Me — Excuse Rolodex MVP. Generate believable, copy‑ready excuses for Work, Social, Family, or Health scenarios. Open‑source, no backend." />
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-bold">Bail Me <span class="text-slate-400 text-sm font-normal">MVP</span></h1>
      <nav class="flex gap-2">
        <button id="tab-generate" class="tab-btn px-3 py-1 rounded-lg text-sm font-medium bg-slate-900 text-white">Generate</button>
        <button id="tab-favorites" class="tab-btn px-3 py-1 rounded-lg text-sm font-medium bg-slate-100">Favorites</button>
        <button id="tab-library" class="tab-btn px-3 py-1 rounded-lg text-sm font-medium bg-slate-100">Library</button>
      </nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6">
    <section id="controls" class="grid grid-cols-1 md:grid-cols-4 gap-3">
      <div>
        <label class="block text-xs text-slate-600 mb-1">Category</label>
        <select id="category" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-300">
          <option value="Work">Work</option>
          <option value="Social">Social</option>
          <option value="Family">Family</option>
          <option value="Health">Health</option>
        </select>
      </div>
      <div>
        <label class="block text-xs text-slate-600 mb-1">Intent</label>
        <select id="intent" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-300">
          <option value="Cancel">Cancel</option>
          <option value="Delay">Delay</option>
          <option value="Reschedule">Reschedule</option>
        </select>
      </div>
      <div>
        <label class="block text-xs text-slate-600 mb-1">Tone</label>
        <select id="tone" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-300">
          <option value="formal">Formal</option>
          <option value="casual">Casual</option>
        </select>
      </div>
      <div class="flex items-end">
        <button id="btn-generate" class="w-full rounded-xl bg-slate-900 text-white py-2 font-semibold">Generate</button>
      </div>
    </section>

    <section id="results" class="mt-6 grid gap-3"></section>

    <section id="favorites-view" class="mt-6 hidden">
      <p class="text-sm text-slate-600 mb-2">Your saved excuses live here. They sync locally in this browser (no login required).</p>
      <div id="favorites" class="grid gap-3"></div>
    </section>

    <section id="library-view" class="mt-6 hidden">
      <div class="flex items-center gap-2 mb-3">
        <input id="search" type="search" placeholder="Search library…" class="flex-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-300 px-3 py-2" />
        <span class="text-xs text-slate-500">Total: <span id="lib-count">0</span></span>
      </div>
      <div id="library" class="grid gap-3"></div>
    </section>

    <footer class="mt-12 text-center text-xs text-slate-500">
      <p>Open‑source MVP • No backend • Built with Tailwind. Copy/Share uses Web APIs.</p>
    </footer>
  </main>

  <template id="card-template">
    <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="flex items-start gap-3">
        <div class="flex-1">
          <p class="text-sm leading-relaxed"></p>
          <div class="mt-2 flex flex-wrap gap-2 text-xs text-slate-500">
            <span class="px-2 py-0.5 rounded-full bg-slate-100 category"></span>
            <span class="px-2 py-0.5 rounded-full bg-slate-100 intent"></span>
            <span class="px-2 py-0.5 rounded-full bg-slate-100 tone"></span>
          </div>
        </div>
        <div class="shrink-0 flex flex-col gap-2">
          <button class="btn-copy text-xs px-3 py-1 rounded-lg bg-slate-900 text-white">Copy</button>
          <button class="btn-share text-xs px-3 py-1 rounded-lg bg-slate-100">Share</button>
          <button class="btn-fav text-xs px-3 py-1 rounded-lg bg-amber-50 border border-amber-200">☆ Save</button>
        </div>
      </div>
    </article>
  </template>

  <script>
    const EXCUSES = [
      { id: 1, category: 'Work', intent: 'Cancel', tone: 'formal', text: "I need to cancel — we've had an urgent blocker on a live issue and I'm being pulled into a fix." },
      { id: 2, category: 'Work', intent: 'Cancel', tone: 'casual', text: "Gotta drop — prod just hiccuped and I'm on deck to help. Rain check?" },
      { id: 3, category: 'Work', intent: 'Cancel', tone: 'formal', text: "Apologies, a critical dependency slipped and I have to stay on the war-room call. Can we skip today?" },
      { id: 4, category: 'Work', intent: 'Delay', tone: 'formal', text: "Running 20–25 mins late — a standup overran due to escalations. Appreciate your patience." },
      { id: 5, category: 'Work', intent: 'Delay', tone: 'casual', text: "Stuck in a spillover standup. Will join in ~15. Sorry!" },
      { id: 6, category: 'Work', intent: 'Delay', tone: 'formal', text: "Caught behind an impromptu review with leadership. Joining shortly; thanks for holding." },
      { id: 7, category: 'Work', intent: 'Reschedule', tone: 'formal', text: "Could we move this to tomorrow same time? A customer call just landed on this slot." },
      { id: 8, category: 'Work', intent: 'Reschedule', tone: 'casual', text: "Mind if we shift to tomorrow? Client pinged and I have to hop on." },
      { id: 9, category: 'Work', intent: 'Reschedule', tone: 'formal', text: "Requesting a reschedule — there's a release go/no-go meeting I must attend." },
      { id: 10, category: 'Social', intent: 'Cancel', tone: 'casual', text: "I'm crashing post-work today. Can we skip tonight? I owe you one." },
      { id: 11, category: 'Social', intent: 'Cancel', tone: 'formal', text: "I'll have to pass this evening — a family matter came up unexpectedly." },
      { id: 12, category: 'Social', intent: 'Cancel', tone: 'casual', text: "Weather's gone sideways and traffic is nuts. Let's do another day?" },
      { id: 13, category: 'Social', intent: 'Delay', tone: 'casual', text: "Running 20 late — the cab took a detour thanks to rain." },
      { id: 14, category: 'Social', intent: 'Delay', tone: 'formal', text: "Delayed by ~15 minutes due to traffic. I'll update ETA shortly." },
      { id: 15, category: 'Social', intent: 'Delay', tone: 'casual', text: "Finding parking is a side quest today. Five–ten mins!" },
      { id: 16, category: 'Social', intent: 'Reschedule', tone: 'casual', text: "Heads up — a work thing spilled over. Can we push to the weekend?" },
      { id: 17, category: 'Social', intent: 'Reschedule', tone: 'formal', text: "Could we move to Saturday afternoon? My schedule shifted last minute." },
      { id: 18, category: 'Social', intent: 'Reschedule', tone: 'casual', text: "Got roped into something at home. Can we do Sunday brunch instead?" },
      { id: 19, category: 'Family', intent: 'Cancel', tone: 'formal', text: "I won't be able to make it today — there's an urgent task at work I can't step away from." },
      { id: 20, category: 'Family', intent: 'Cancel', tone: 'casual', text: "Sorry, something blew up at work. Let's skip today — I'll come by tomorrow." },
      { id: 21, category: 'Family', intent: 'Cancel', tone: 'formal', text: "Need to cancel — not keeping well and want to avoid passing anything on." },
      { id: 22, category: 'Family', intent: 'Delay', tone: 'casual', text: "Stuck at the chemist; will be 15–20 late." },
      { id: 23, category: 'Family', intent: 'Delay', tone: 'formal', text: "Running late due to errands taking longer than planned. Reaching soon." },
      { id: 24, category: 'Family', intent: 'Delay', tone: 'casual', text: "Traffic near the market is chaos. Ten mins tops." },
      { id: 25, category: 'Family', intent: 'Reschedule', tone: 'formal', text: "Can we move this to tomorrow morning? I have a prior commitment I can't shift." },
      { id: 26, category: 'Family', intent: 'Reschedule', tone: 'casual', text: "Plan change at my end — can we do it after dinner instead?" },
      { id: 27, category: 'Family', intent: 'Reschedule', tone: 'formal', text: "Requesting a reschedule to Sunday — family engagement timings changed." },
      { id: 28, category: 'Health', intent: 'Cancel', tone: 'formal', text: "I'll skip today — not feeling great and want to rest it out." },
      { id: 29, category: 'Health', intent: 'Cancel', tone: 'casual', text: "Bit under the weather. Tapping out tonight." },
      { id: 30, category: 'Health', intent: 'Cancel', tone: 'formal', text: "Canceling for today — doctor advised rest. Let's reconnect tomorrow." },
      { id: 31, category: 'Health', intent: 'Delay', tone: 'casual', text: "Pharmacy queue was a saga. Running 15 late." },
      { id: 32, category: 'Health', intent: 'Delay', tone: 'formal', text: "Will be slightly delayed — picking up medication on the way." },
      { id: 33, category: 'Health', intent: 'Delay', tone: 'casual', text: "Quick clinic stop took longer. On my way!" },
      { id: 34, category: 'Health', intent: 'Reschedule', tone: 'formal', text: "Could we move this to tomorrow? I'd like to rest and avoid spreading anything." },
      { id: 35, category: 'Health', intent: 'Reschedule', tone: 'casual', text: "Energy levels are meh today. Can we do this tomorrow evening?" },
      { id: 36, category: 'Health', intent: 'Reschedule', tone: 'formal', text: "Doctor asked me to avoid stepping out today — can we shift to the weekend?" },
      { id: 37, category: 'Work', intent: 'Delay', tone: 'casual', text: "Stuck near Silk Board thanks to rain. 15–20 mins late." },
      { id: 38, category: 'Social', intent: 'Cancel', tone: 'casual', text: "Power cut here and the router's dead. Let's skip tonight?" },
      { id: 39, category: 'Work', intent: 'Reschedule', tone: 'formal', text: "Internet is unstable due to the rains. Requesting to move this to later today." },
      { id: 40, category: 'Social', intent: 'Reschedule', tone: 'casual', text: "Delhi traffic + random protest near Ring Road. Can we do tomorrow?" }
    ];

    const STORAGE_KEY = 'bailme_favorites_v1';
    const state = { favorites: new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')), activeTab: 'generate' };
    const resultsEl = document.getElementById('results');
    const favsViewEl = document.getElementById('favorites-view');
    const favsEl = document.getElementById('favorites');
    const libViewEl = document.getElementById('library-view');
    const libEl = document.getElementById('library');
    const libCountEl = document.getElementById('lib-count');
    const searchEl = document.getElementById('search');

    function saveFavorites(){ localStorage.setItem(STORAGE_KEY, JSON.stringify([...state.favorites])); }
    function pickRandom(arr, n=3){ const c=[...arr]; for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]];} return c.slice(0, Math.min(n,c.length)); }
    function filterExcuses({category,intent,tone}){ return EXCUSES.filter(e=>(!category||e.category===category)&&(!intent||e.intent===intent)&&(!tone||e.tone===tone)); }

    function renderCard(excuse){
      const tpl=document.getElementById('card-template'); const node=tpl.content.firstElementChild.cloneNode(true);
      node.querySelector('p').textContent=excuse.text;
      node.querySelector('.category').textContent=excuse.category;
      node.querySelector('.intent').textContent=excuse.intent;
      node.querySelector('.tone').textContent=excuse.tone;

      const copyBtn=node.querySelector('.btn-copy');
      copyBtn.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(excuse.text); copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1200);}catch(e){ alert('Copy failed. Select and copy manually.'); }
      });

      const shareBtn=node.querySelector('.btn-share');
      if(!navigator.share){ shareBtn.classList.add('hidden'); } else {
        shareBtn.addEventListener('click', ()=>{ navigator.share({ text: excuse.text, title:'Bail Me excuse' }).catch(()=>{}); });
      }

      const favBtn=node.querySelector('.btn-fav');
      const isFav=state.favorites.has(excuse.id);
      if(isFav){ favBtn.textContent='★ Saved'; favBtn.classList.remove('bg-amber-50'); favBtn.classList.add('bg-amber-200'); }
      favBtn.addEventListener('click', ()=>{
        if(state.favorites.has(excuse.id)){ state.favorites.delete(excuse.id); favBtn.textContent='☆ Save'; favBtn.classList.add('bg-amber-50'); favBtn.classList.remove('bg-amber-200'); }
        else { state.favorites.add(excuse.id); favBtn.textContent='★ Saved'; favBtn.classList.remove('bg-amber-50'); favBtn.classList.add('bg-amber-200'); }
        saveFavorites(); if(state.activeTab==='favorites') renderFavorites();
      });
      return node;
    }

    function renderResults(list){ resultsEl.innerHTML=''; if(!list.length){ resultsEl.innerHTML='<p class="text-sm text-slate-600">No matches. Try another combination.</p>'; return;} list.forEach(e=>resultsEl.appendChild(renderCard(e))); }
    function renderFavorites(){ favsEl.innerHTML=''; const favs=EXCUSES.filter(e=>state.favorites.has(e.id)); if(!favs.length){ favsEl.innerHTML='<p class="text-sm text-slate-600">No favorites yet. Save your go‑to lines for quick access.</p>'; return;} favs.forEach(e=>favsEl.appendChild(renderCard(e))); }
    function renderLibrary(filter=''){ libEl.innerHTML=''; const norm=filter.trim().toLowerCase(); const list=EXCUSES.filter(e=>!norm||e.text.toLowerCase().includes(norm)); libCountEl.textContent=String(list.length); list.forEach(e=>libEl.appendChild(renderCard(e))); }

    const tabGenerate=document.getElementById('tab-generate');
    const tabFavorites=document.getElementById('tab-favorites');
    const tabLibrary=document.getElementById('tab-library');
    function setActiveTab(tab){
      state.activeTab=tab;
      [tabGenerate,tabFavorites,tabLibrary].forEach(btn=>btn.classList.remove('bg-slate-900','text-white'));
      document.querySelector(`#tab-${tab}`).classList.add('bg-slate-900','text-white');
      document.getElementById('controls').classList.toggle('hidden', tab!=='generate');
      document.getElementById('results').classList.toggle('hidden', tab!=='generate');
      document.getElementById('favorites-view').classList.toggle('hidden', tab!=='favorites');
      document.getElementById('library-view').classList.toggle('hidden', tab!=='library');
      if(tab==='favorites') renderFavorites();
      if(tab==='library') renderLibrary(searchEl.value);
    }

    document.getElementById('btn-generate').addEventListener('click', ()=>{
      const category=document.getElementById('category').value;
      const intent=document.getElementById('intent').value;
      const tone=document.getElementById('tone').value;
      const matches=filterExcuses({category,intent,tone});
      renderResults(pickRandom(matches,3));
    });

    tabGenerate.addEventListener('click', ()=>setActiveTab('generate'));
    tabFavorites.addEventListener('click', ()=>setActiveTab('favorites'));
    tabLibrary.addEventListener('click', ()=>setActiveTab('library'));

    searchEl.addEventListener('input', (e)=>renderLibrary(e.target.value));

    setActiveTab('generate');
    renderResults(pickRandom(EXCUSES,3));
  </script>

  <!-- PWA runtime manifest + SW so it can be installed and work offline -->
  <script>
    (function createManifest() {
      const manifest = {
        name: "Bail Me — MVP",
        short_name: "BailMe",
        start_url: ".",
        scope: ".",
        display: "standalone",
        background_color: "#ffffff",
        theme_color: "#0f172a",
        icons: [
          { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%230f172a'/%3E%3Ctext x='50%' y='56%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='280' fill='white'%3EB%3C/text%3E%3C/svg%3E", sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" },
          { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%230f172a'/%3E%3Ctext x='50%' y='56%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='108' fill='white'%3EB%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = url;
      document.head.appendChild(link);
      const metaTheme = document.createElement('meta');
      metaTheme.name = 'theme-color';
      metaTheme.content = manifest.theme_color;
      document.head.appendChild(metaTheme);
    })();

    (function registerSW() {
      if (!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE = 'bailme-v1';
        const OFFLINE_URL = './';
        self.addEventListener('install', event => {
          event.waitUntil((async () => {
            const cache = await caches.open(CACHE);
            await cache.add(new Request(OFFLINE_URL, { cache: 'reload' }));
          })());
          self.skipWaiting();
        });
        self.addEventListener('activate', event => {
          event.waitUntil((async () => {
            const keys = await caches.keys();
            await Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)));
          })());
          self.clients.claim();
        });
        self.addEventListener('fetch', event => {
          const req = event.request;
          event.respondWith((async () => {
            try {
              const net = await fetch(req);
              const cache = await caches.open(CACHE);
              cache.put(req, net.clone()).catch(() => {});
              return net;
            } catch (err) {
              const cache = await caches.open(CACHE);
              const cached = await cache.match(req);
              if (cached) return cached;
              if (req.mode === 'navigate') return cache.match(OFFLINE_URL);
              throw err;
            }
          })());
        });
      `;
      const blob = new Blob([swCode], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).catch(() => {});
    })();

    (function addInstallPrompt() {
      let deferred;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferred = e;
        const btn = document.createElement('button');
        btn.textContent = 'Install app';
        btn.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-xl bg-slate-900 text-white shadow-lg';
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          try { await deferred.prompt(); } catch {}
          btn.remove();
        });
        document.body.appendChild(btn);
      });
    })();
  </script>
</body>
</html>
